# Aitri Agent Integration Guide

How to integrate Aitri into an AI agent's workflow as the engineering system of record.

---

## Vision

Aitri is the guardrail that prevents agentic hallucination in software delivery.
The agent moves fast; Aitri ensures every artifact traces back to a reviewed specification.

Human interaction is limited to:
1. Providing the initial intent (idea)
2. Approving the spec (`aitri approve`)
3. Authorizing implementation (`aitri go`)
4. Accepting delivery (`aitri deliver`)

Everything in between is handled by the agent under Aitri's enforcement contract.

---

## 1. Session Lifecycle Protocol (The Relay)

Every agent session follows this sequence:

### Start of session
```bash
aitri checkpoint show          # read saved state from .aitri/DEV_STATE.md
aitri resume json              # get recommendedCommand and feature context
```

### End of session
```bash
aitri checkpoint "<what was done> — next: <what to do next>"
```

The checkpoint is stored in `.aitri/DEV_STATE.md`. Any agent resuming the session reads
this file first. See `docs/guides/SELF_EVOLUTION.md` for the full Relay Protocol.

---

## 2. Pre-Go Phase: Agent as Content Author

### 2.1. Spec Phase

```bash
aitri draft --feature <name> --idea "<intent>"     # create draft spec
aitri spec-improve --feature <name>                # AI reviews spec for quality gaps
aitri approve --feature <name>                     # validate and lock spec
aitri discover --feature <name>                    # structured discovery interview
```

The agent can use `spec-improve` output to refine the spec before approval.

### 2.2. Auditor Mode (preferred over default plan)

Instead of letting Aitri infer backlog/tests from heuristics, the agent generates them:

**Step 1: Read the approved spec**
```bash
cat specs/approved/<feature>.md
```

**Step 2: Generate `agent-backlog.md`**

The agent writes a backlog file following this structure:
```markdown
# Backlog: <feature>

## User Stories

### US-1
- As a <actor>, I want <action>, so that <benefit>.
- Trace: FR-1, AC-1, AC-2

### US-2
- As a <actor>, I want <action>, so that <benefit>.
- Trace: FR-2, AC-3
```

Rules:
- Every US must have a `Trace:` line
- Every FR-* referenced must exist in the approved spec's Functional Rules section
- Every AC-* referenced must exist in the approved spec's Acceptance Criteria section

**Step 3: Generate `agent-tests.md`**

```markdown
# Test Cases: <feature>

### TC-1
- Title: Validate user credentials before granting access
- Trace: US-1, FR-1, AC-1

### TC-2
- Title: Reject invalid credentials with error message
- Trace: US-2, FR-2, AC-3
```

Rules:
- Every TC must have a `Trace:` line
- Every US-* referenced must exist in the agent backlog
- Every FR-* referenced must exist in the approved spec

**Step 4: Preview the delta**
```bash
aitri diff --feature <name> --proposed agent-backlog.md
```
Review added/removed/modified stories before submitting.

**Step 5: Submit for audit**
```bash
aitri plan --feature <name> --ai-backlog agent-backlog.md --ai-tests agent-tests.md
```

Aitri validates all traces. If audit passes, backlog and tests are written atomically.
If audit fails, nothing is written — fix the reported issues and retry.

### 2.3. Semantic Validation

After plan succeeds, validate that User Stories satisfy FR intent:
```bash
aitri verify-intent --feature <name>
aitri verify-intent --feature <name> --story US-1    # single story
aitri verify-intent --feature <name> --json          # pipeline output
```

Requires `ai` section in `.aitri.json`:
```json
{
  "ai": {
    "provider": "claude",
    "model": "claude-opus-4-6",
    "apiKeyEnv": "ANTHROPIC_API_KEY"
  }
}
```

---

## 3. Post-Go Phase: Agent as Implementer

```bash
aitri go --feature <name> --yes                     # unlock factory mode

aitri build --feature <name> --yes                  # scaffold test stubs + contract placeholders
aitri testgen --feature <name>                      # LLM generates behavioral test bodies
aitri contractgen --feature <name>                  # LLM implements contract functions
aitri prove --feature <name> --mutate               # run TC stubs, write proof-of-compliance
aitri deliver --feature <name>                      # final gate
```

Each test stub in `tests/<feature>/generated/` has the contract import pre-written:
```js
// Generated by aitri build
import { fr_1_validate_user_credentials } from "../../../src/contracts/fr-1-validate-user.js";
import test from "node:test";
import assert from "node:assert/strict";
// TODO: implement — TC-1 title
```

---

## 4. Handling Brownfield Backlogs (Incremental Updates)

When updating an existing feature, use `aitri diff` before submitting:

```bash
# Agent generates updated backlog
aitri diff --feature <name> --proposed updated-backlog.md    # review delta
aitri diff --feature <name> --proposed updated-backlog.md --json    # pipeline

# If delta is acceptable, submit
aitri plan --feature <name> --ai-backlog updated-backlog.md --ai-tests updated-tests.md
```

This prevents silent overwrites and gives the human a clear change summary before any write.

---

## 5. Error Recovery

| Error | Cause | Fix |
|-------|-------|-----|
| `AUDIT FAILED — FR-99 not in spec` | Backlog references non-existent FR | Fix the Trace line in the backlog |
| `verify-intent: fail` | US does not satisfy FR intent | Revise the User Story text |
| `Approved spec not found` | Wrong feature name or spec not approved | Run `aitri approve --feature <name>` |
| `Backlog not found` | Plan not run yet | Run `aitri plan` first |

---

## 6. JSON Pipeline Mode

All Aitri commands support `--json` or `--non-interactive` for machine-readable output:

```bash
aitri resume json
aitri diff --feature user-auth --proposed new.md --json
aitri verify-intent --feature user-auth --json
aitri prove --feature user-auth --json
```

The agent should read `recommendedCommand` from `aitri resume json` to determine the next step.

---

## 7. Quick Reference

| Phase | Command | Agent action |
|-------|---------|--------------|
| Start session | `aitri checkpoint show` | Read saved state |
| Spec | `aitri draft / approve` | Provide idea, approve output |
| Spec quality | `aitri spec-improve` | Use suggestions to improve spec |
| Discovery | `aitri discover` | Generate discovery artifact |
| Plan (Auditor) | `aitri plan --ai-backlog --ai-tests` | Generate files, submit for audit |
| Validate intent | `aitri verify-intent` | Confirm US ↔ FR alignment |
| Diff | `aitri diff --proposed` | Preview backlog changes |
| Go | `aitri go` | Unlock factory |
| Build | `aitri build` | Scaffold test stubs + contract placeholders |
| Test gen | `aitri testgen` | LLM generates behavioral test bodies |
| Contract gen | `aitri contractgen` | LLM implements contract functions |
| Prove | `aitri prove --mutate` | Run TC stubs, write proof-of-compliance |
| Deliver | `aitri deliver` | Final gate |
| End session | `aitri checkpoint "<summary>"` | Save state for next session |
